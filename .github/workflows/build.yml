name: build Workflow

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
        default: ubuntu:jammy
      run_platform:
        required: false
        type: string
        default: ubuntu-22.04
      tool_chain:
        required: true
        type: string
        default: gcc-11
      ros_distro:
        required: false
        type: string
        default: humble

jobs:
  build:
    runs-on: ${{ inputs.run_platform }}
    container:
      image: ${{ inputs.image_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: check ROS 2
        shell: bash
        env:
          ROS_DISTRO_INPUT: ${{ inputs.ros_distro }}
        run: |
          # ROS_DISTRO_INPUT is passed from ci.yml matrix (ros_distro field)
          # If not provided, auto-detect from image name as fallback
          if [ -z "$ROS_DISTRO_INPUT" ] || [ "$ROS_DISTRO_INPUT" == "" ]; then
            if [[ "${{ inputs.image_name }}" == *"jazzy"* ]]; then
              ROS_DISTRO_INPUT="jazzy"
            else
              ROS_DISTRO_INPUT="humble"
            fi
          fi
          echo "Using ROS distro: $ROS_DISTRO_INPUT"
          source /opt/ros/${ROS_DISTRO_INPUT}/setup.bash
          ros2 --help
          echo "ROS_DISTRO: $ROS_DISTRO"
          echo "ROS_VERSION: $ROS_VERSION"
          echo "ROS_PYTHON_VERSION: $ROS_PYTHON_VERSION"

          # remove ros2-latest.list to avoid the error:
          # W: GPG error: http://packages.ros.org/ros2/ubuntu jammy InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY F42ED6FBAB17C654

          if [ -f /etc/apt/sources.list.d/ros2-latest.list ]; then
            rm /etc/apt/sources.list.d/ros2-latest.list
          fi

      - name: Install dependencies for build
        shell: bash
        env:
          ROS_DISTRO_INPUT: ${{ inputs.ros_distro }}
        run: |
          # ROS_DISTRO_INPUT is passed from ci.yml matrix (ros_distro field)
          # If not provided, auto-detect from image name as fallback
          if [ -z "$ROS_DISTRO_INPUT" ] || [ "$ROS_DISTRO_INPUT" == "" ]; then
            if [[ "${{ inputs.image_name }}" == *"jazzy"* ]]; then
              ROS_DISTRO_INPUT="jazzy"
            else
              ROS_DISTRO_INPUT="humble"
            fi
          fi
          
          echo "Installing dependencies for ROS distro: $ROS_DISTRO_INPUT"
          apt update -y
          
          # Install dependencies based on ROS distro
          # Humble: Ubuntu 22.04 (Jammy) with Python 3.10
          # Jazzy: Ubuntu 24.04 (Noble) with Python 3.12
          if [ "$ROS_DISTRO_INPUT" == "jazzy" ]; then
            # Jazzy environment: Ubuntu 24.04, Python 3.12
            apt install curl wget python3.12 python3.12-venv python3-pip make vim libglib2.0-dev libcurl4-openssl-dev zip lcov bc git build-essential autoconf libtool pkg-config doxygen libacl1-dev python3-empy python3-catkin-pkg python3-lark -y
            # Ensure python3 points to python3.12
            update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 || true
          else
            # Humble environment: Ubuntu 22.04, Python 3.10
            apt install curl wget python3.10 python3-pip make vim libglib2.0-dev libcurl4-openssl-dev python3-venv zip lcov bc git build-essential autoconf libtool pkg-config doxygen libacl1-dev python3-empy python3-catkin-pkg python3-lark -y
          fi
          
          # Create virtual environment for Python packages
          python3 -m venv /tmp/venv
          source /tmp/venv/bin/activate
          pip install --upgrade pip
          # Install ROS 2 build dependencies
          # For Humble, use empy 3.3.4 which is compatible with ROS 2 Humble
          # For Jazzy, use latest empy
          if [ "$ROS_DISTRO_INPUT" == "jazzy" ]; then
            pip install catkin_pkg empy lark-parser numpy
          else
            pip install catkin_pkg "empy==3.3.4" lark-parser numpy
          fi
          # Install other Python packages
          pip install pyinstaller jinja2 setuptools==74.1.2 pyyaml sphinx sphinx_rtd_theme sphinx-design myst-parser build linkify-it-py sphinx_multiversion

      - name: download and Use cmake
        shell: bash
        run: |
          source /tmp/venv/bin/activate
          pip install cmake==3.28.0
          cmake --version

      - name: set up rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c
        with:
          toolchain: 1.75.0

      - name: set up toolchain
        shell: bash
        env:
          tool_chain: ${{ inputs.tool_chain }}
        run: |
          if [[ "$tool_chain" =~ gcc-([0-9.]+) ]]; then
              version="${BASH_REMATCH[1]}"
              apt-get update -y
              apt-get install software-properties-common -y
              add-apt-repository ppa:ubuntu-toolchain-r/test -y
              apt-get update -y
              apt-get install gcc-$version g++-$version -y
              echo "Extracted version: $version"
              gcc-$version --version
              g++-$version --version
              echo "CC=$(which gcc-$version)" >> $GITHUB_ENV
              echo "CXX=$(which g++-$version)" >> $GITHUB_ENV
          elif [[ "$tool_chain" =~ clang-([0-9.]+) ]]; then
              apt install lsb-release wget software-properties-common gnupg -y
              version="${BASH_REMATCH[1]}"
              echo $version
              wget https://apt.llvm.org/llvm.sh
              chmod +x llvm.sh
              ./llvm.sh ${version}
              clang-$version --version
              clang++-$version --version
              echo "CC=$(which clang-$version)" >> $GITHUB_ENV
              echo "CXX=$(which clang++-$version)" >> $GITHUB_ENV
          fi

      - name: start build in linux
        shell: bash
        env:
          ROS_DISTRO_INPUT: ${{ inputs.ros_distro }}
        run: |
          # ROS_DISTRO_INPUT is passed from ci.yml matrix (ros_distro field)
          # If not provided, auto-detect from image name as fallback
          if [ -z "$ROS_DISTRO_INPUT" ] || [ "$ROS_DISTRO_INPUT" == "" ]; then
            if [[ "${{ inputs.image_name }}" == *"jazzy"* ]]; then
              ROS_DISTRO_INPUT="jazzy"
            else
              ROS_DISTRO_INPUT="humble"
            fi
          fi
          echo "Building with ROS distro: $ROS_DISTRO_INPUT"
          source /opt/ros/${ROS_DISTRO_INPUT}/setup.bash
          source /tmp/venv/bin/activate
          # Ensure CMake uses the virtual environment's Python
          VENV_PYTHON="$(which python3)"
          echo "Using Python: $VENV_PYTHON"
          # Pass Python3_EXECUTABLE to build.sh via cmake args
          ./build.sh -DPython3_EXECUTABLE="$VENV_PYTHON"
          ls -lh .
          ls -lh build/
          ls -lh build/aimrt_py_pkg
          ls -lh build/aimrt_py_pkg/dist

      - name: upload build artifact
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.run_platform }}_artifact
          path: |
            build/aimrt_py_pkg/dist
          retention-days: 3


